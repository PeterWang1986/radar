# Implementation of Crowd Counting

This repository supply a TensorFlow implementation of
* [Single Image Crowd Counting via Multi Column Convolutional Neural Network](https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Zhang_Single-Image_Crowd_Counting_CVPR_2016_paper.pdf)
* [CSRNet: Dilated Convolutional Neural Networks for Understanding the Highly Congested Scenes](https://arxiv.org/abs/1802.10062)

The code follow the design idea of this work [SSD-Tensorflow](https://github.com/balancap/SSD-Tensorflow), and some code are copied from there.

## Models
All the models are checked in logs/, i resized the input image into (512, 512, ?) and do NOT use pre-training strategy, here is the performance test from my side:

| model | training data | testing data | MAE | RMSE | notes |
|-------|:-------------:|:------------:|:---:|:---:|:-----:|
| model_v6 | shtech_part_B_train | shtech_part_B_test | 20.7 | 33.9 | using gray image as input & mcnn.nets_v1|
| model_v18 | shtech_part_B_train | shtech_part_B_test | 16.3 | 24.8 | using RGB image as input & mcnn.nets_v4|
| model_v21 | shtech_part_B_train | shtech_part_B_test | 14.1 | 26.5 | using RGB image as input & vgg.nets_v1.backend|
| model_v103 | shtech_part_A_train | shtech_part_A_test | 109.4 | 173.5 | using RGB image as input & mcnn.nets_v1|
| model_v122 | shtech_part_A_train | shtech_part_A_test | 81.4 | 149.6 | using RGB image as input & vgg.nets_v1.backend_inception|

NOTE - you need to update the nets_v<xxx> by yourself in nets/mcnn.py

## Example
```bash
python forecast.py --model_path=./logs/model_v6/model.ckpt-38941 --image_path=./testdata/crowd_count_89.jpg
```

And you will see(the ground truth is 89):

pred counts: 94.27829
![](testdata/crowd_count_89_result.png)

NOTE: if your model use 3-channel image as input, you should change 'CHANNELS' to 3 in forecast.py.

## Training
The script `train_network.py` is used to train the model, but you need to prepare the training data firstly. -:)
### data setup
Suppose your work directory is ROOT=/.../radar/
1. download datasets from: https://pan.baidu.com/s/1nuAYslz (ref: https://github.com/svishwa/crowdcount-mcnn)
2. cd $ROOT/datasets/ & python shtech_to_tfrecords.py

NOTE - you need to update some parameters in shtech_to_tfrecords.py:
* dataset_dir: the root directory of original dataset
* output_dir: where do you want to save the tfrecords
* RAND_CROP_COUNT: random crop counts (default 10)
* CHANNELS: 1 which means convert the input image into gray scale (3 to RGB)

### train models
```bash
python train_network.py \
  --train_dir=./logs/model_v_xxx \
  --dataset_name=shtech_part_B \
  --dataset_dir=<your training data(tfrecords) which generated by data setup> \
  --batch_size=32 \
  --learning_rate=1e-3 \
  --weight_decay=0.005 \
  --max_number_steps=40000
```
By default I use Adam optimizer and exponential learning rate decay, and you can change it in train_network.py.
NOTE - there are two parameters in train_network.py you shold becareful:
* DATASIZE: the total number of your training records (learning rate decay alogrithm will be influenced)
* CHANNELS: specify the channel of your input image

### test models
You need to specify the test dataset in test_network.py.
```bash
python test_network.py --model_path=<your model path>
```

## Fine-tuning
TODO

